# SARdine

**Browser-native NISAR HDF5 viewer â€” stream cloud-optimized SAR data straight to GPU, no server required.**

The SARdine viewer loads NASA NISAR HDF files directly in the browser. It parses the cloud-optimized HDF5 metadata in a single read, fetches only the chunks needed for the current viewport, and renders them through WebGL shaders on deck.gl. SARdine is optimized to run on either a cloud webVMs or locally, GPUs are not required but .

---

## What it does

| Capability | Detail |
|---|---|
| **NISAR GCOV HDF5** | Full support for L2 Geocoded Covariance products â€” HHHH, HVHV, VHVH, VVVV and cross-pol terms |
| **Cloud-optimized streaming** | Reads the paged-aggregation metadata block (~8 MB), builds a chunk index, then fetches data on demand via byte-range requests â€” the same pattern as COG |
| **RGB polarimetric composites** | HH/HV/VV, Pauli power decomposition, dual-pol VV/VH, and custom presets rendered as three-channel GPU textures |
| **Cloud Optimized GeoTIFF** | Also loads COGs from any URL (S3, HTTP) for ICEYE, Capella, Umbra, Sentinel-1, or any SAR vendor |
| **dB scaling on GPU** | GLSL shader converts linear power to ÏƒÂ° decibels, applies colormaps (grayscale, viridis, inferno, plasma, phase), and does per-channel contrast stretch â€” all at 60 fps |
| **GeoTIFF export** | Export the current RGB composite view as a georeferenced 3-band GeoTIFF with correct CRS and tiepoints |
| **Figure export** | Capture the deck.gl canvas as a PNG with metadata overlay |

---

## Quick start

```bash
npm install
npm run dev
```

Open http://localhost:5173. Drag a NISAR `.h5` file onto the file picker, or paste a COG URL.

---

## Loading NISAR HDF5 files

### In the app

1. Set **File Type** â†’ NISAR GCOV HDF5
2. Click the file picker and select a `.h5` file
3. SARdine reads metadata, discovers available frequency bands (L/S) and polarizations
4. Choose **Single Band** or **RGB Composite** display mode
5. Click **Load** â€” data streams in chunk-by-chunk

### Programmatically

```javascript
import {
  listNISARDatasets,
  loadNISARGCOV,
  loadNISARRGBComposite,
} from 'sardine';

// Discover what's in the file
const datasets = await listNISARDatasets(file);
// â†’ [{frequency: 'A', polarization: 'HHHH'}, {frequency: 'A', polarization: 'HVHV'}, ...]

// Load a single polarization band
const { getTile, bounds, width, height, crs, stats } = await loadNISARGCOV(file, {
  frequency: 'A',
  polarization: 'HHHH',
});

// Load an RGB composite
const rgb = await loadNISARRGBComposite(file, {
  frequency: 'A',
  compositeId: 'pauli-power',
});
```

### RGB composite presets

| Preset | R | G | B | Use case |
|---|---|---|---|---|
| `hh-hv-vv` | HHHH | HVHV | VVVV | Standard quad-pol overview |
| `pauli-power` | \|HHâˆ’VV\| | HV | HH+VV | Scattering mechanism decomposition |
| `dual-pol-v` | VV | VH | VVÃ·VH | Sentinel-1 style dual-pol |
| `dual-pol-h` | HH | HV | HHÃ·HV | H-transmit dual-pol |

---

## Loading Cloud Optimized GeoTIFFs

```javascript
import { loadCOG, SARViewer } from 'sardine';

const cog = await loadCOG('https://bucket.s3.amazonaws.com/sar-image.tif');

<SARViewer
  cogUrl={cog.cogUrl}
  bounds={cog.bounds}
  contrastLimits={[-25, 0]}
  useDecibels={true}
  colormap="grayscale"
/>
```

SARdine auto-detects projected vs geographic coordinates and selects the appropriate overview level for the current zoom.

---

## How cloud-optimized HDF5 streaming works

NISAR adopted the same cloud-optimization strategy developed by NSIDC for ICESat-2:

1. **Paged aggregation** â€” all file-level metadata is consolidated at the front of the file in a fixed-size page
2. **Large chunk sizes** â€” 2â€“10 MiB data chunks for efficient range reads
3. **Minimal variable-length types** â€” enables clean HTTP range GET access

SARdine's `h5chunk` module exploits this:

```
Fetch metadata page (~8 MB, one request)
  â†’ Parse HDF5 superblock, object headers, B-tree
  â†’ Build chunk index: {dataset â†’ [{offset, size, chunk_coords}]}
  â†’ For current viewport, fetch intersecting chunks via Range requests
  â†’ Decompress (deflate + shuffle) â†’ Float32Array
  â†’ Push to deck.gl as WebGL texture
  â†’ GPU does dB conversion + colormap at 60 fps
```

This is essentially a **JavaScript-native Kerchunk** â€” the same byte-range streaming pattern that makes COG fast, applied to HDF5.

---

## Architecture

```
src/
â”œâ”€â”€ loaders/
â”‚   â”œâ”€â”€ h5chunk.js          # Cloud-optimized HDF5 chunk reader (JS Kerchunk)
â”‚   â”œâ”€â”€ nisar-loader.js     # NISAR GCOV product loader (h5chunk + h5wasm)
â”‚   â”œâ”€â”€ hdf5-chunked.js     # Fallback chunked HDF5 reader
â”‚   â””â”€â”€ cog-loader.js       # Cloud Optimized GeoTIFF loader
â”œâ”€â”€ layers/
â”‚   â”œâ”€â”€ SARTileLayer.js     # deck.gl tile layer with SAR shaders
â”‚   â”œâ”€â”€ SARBitmapLayer.js   # Full-image bitmap layer
â”‚   â”œâ”€â”€ SARTiledCOGLayer.js # Tiled COG with dynamic overviews
â”‚   â””â”€â”€ shaders.js          # GLSL: dB scaling, 5 colormaps, contrast
â”œâ”€â”€ viewers/
â”‚   â”œâ”€â”€ SARViewer.jsx       # Primary orthographic viewer
â”‚   â”œâ”€â”€ ComparisonViewer.jsx # Side-by-side + swipe comparison
â”‚   â””â”€â”€ MapViewer.jsx       # MapLibre basemap with SAR overlay
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Histogram.jsx       # Per-channel histogram with contrast sliders
â”‚   â”œâ”€â”€ StatusWindow.jsx    # Collapsible log panel
â”‚   â”œâ”€â”€ LoadingIndicator.jsx
â”‚   â””â”€â”€ ScaleBar.jsx
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ sar-composites.js   # RGB composite presets (Pauli, dual-pol, etc.)
â”‚   â”œâ”€â”€ colormap.js         # Grayscale, viridis, inferno, plasma, phase
â”‚   â”œâ”€â”€ stats.js            # Histogram, percentile, auto-contrast
â”‚   â”œâ”€â”€ geotiff-writer.js   # Minimal GeoTIFF writer for export
â”‚   â””â”€â”€ figure-export.js    # Canvas â†’ PNG export
â””â”€â”€ theme/
    â””â”€â”€ sardine-theme.css   # Design system (dark-first, mission-critical)
```

---

## Tech stack

| Dependency | Role |
|---|---|
| **h5wasm** | Full HDF5 reading for files loaded into memory |
| **h5chunk** (built-in) | Cloud-optimized HDF5 streaming via byte-range requests |
| **geotiff.js** | COG loading and metadata parsing |
| **deck.gl 8.9** | WebGL tile rendering with custom GLSL shaders |
| **React 18** | UI components |
| **MapLibre GL** | Basemap rendering |
| **Vite** | Dev server and build |

---

## Development

```bash
npm install          # Install dependencies
npm run dev          # Start dev server â†’ http://localhost:5173
npm run build        # Production build
npm run example      # Run minimal example app
```

### Testing with NISAR data

Place a NISAR GCOV `.h5` file in `test_data/`, then:

```bash
node test-h5-diagnostic.mjs   # Parse HDF5 structure, report B-tree layout
node test-h5-images.mjs       # Read chunks, write PGM images to test_output/
```

---

## Roadmap

| Feature | Status |
|---|---|
| NISAR GCOV HDF5 loading (h5wasm) | âœ… |
| Cloud-optimized HDF5 streaming (h5chunk) | âœ… |
| RGB polarimetric composites | âœ… |
| COG loading + tiled rendering | âœ… |
| GPU dB scaling + colormaps | âœ… |
| Per-channel histogram + contrast | âœ… |
| GeoTIFF RGB export | âœ… |
| State-as-markdown editing | âœ… |
| HTTP range-request streaming (S3/HTTPS) | ðŸ”œ |
| B-tree v2 parsing | ðŸ”œ |
| Worker thread decompression | ðŸ”œ |
| Chat-driven state control | ðŸ”œ |
| Basemap annotations + drawing | ðŸ”œ |
| GUNW / InSAR phase visualization | ðŸ”œ |
| ASF catalog search integration | ðŸ”œ |

---

## Design

SARdine uses a dark-first design system built for operational SAR monitoring. Deep navy backgrounds, monospace data typography (JetBrains Mono), and a signal-color palette: cyan for interactive elements, orange for alerts, green/magenta for VV/HH polarization channels. See [docs/sardine-style-guide.html](docs/sardine-style-guide.html) for the full component reference.

---

## License

MIT

## Acknowledgments

- [h5wasm](https://github.com/usnistgov/h5wasm) â€” HDF5 in WebAssembly
- [geotiff.js](https://geotiffjs.github.io/) â€” GeoTIFF parsing
- [deck.gl](https://deck.gl/) â€” WebGL rendering
- NISAR cloud-optimization strategy by [NSIDC](https://nsidc.org/) and JPL
- Earth Big Data LLC Ã— CCNY Earth & Atmospheric Sciences
